---
- hosts: localhost
  connection: local
  roles:
    - pylabs.uwsgi
    - pylabs.letsencrypt_auth
    - pylabs.percona # for ngram support. MariaDB 目前還不支援
  tasks:
    - name: 安裝 redis-server
      apt:
        name: "redis-server"
        state: present
    - name: 設定 redis-server 連線密碼
      lineinfile:
        path: "/etc/redis/redis.conf"
        regexp: "^# requirepass "
        line: "requirepass {{ redis_password }}"
      when: redis_password
      notify: restart redis-server
    - block:
        - name: 佈署 production 環境的設定檔
          template:
            src: "production.ini.j2"
            dest: "{{ project_base_dir }}/production.ini"
            owner: "www-data"
            group: "www-data"
            mode: "0600"
        - name: 建立專案 .venv 目錄
          command: "python3 -m venv .venv"
          args:
            chdir: "{{ project_base_dir }}"
            creates: ".venv"
        - name: 更新專案 .venv 套件
          command: ./.venv/bin/pip install --upgrade pip setuptools poetry
          args:
            chdir: "{{ project_base_dir }}"
        - name: 使用 poetry 安裝專案相依套件
          command: ./.venv/bin/poetry install
          args:
            chdir: "{{ project_base_dir }}"
        - name: 執行資料庫初始化
          command: ./.venv/bin/poetry run .venv/bin/inv db.init
          args:
            chdir: "{{ project_base_dir }}"
        - name: 佈署 uwsgi 設定檔 (uwsgi emperor 會自動重啟這個服務)
          template:
            src: "uwsgi.ini.j2"
            dest: "/opt/uwsgi/etc/{{ project_domain_name }}.ini"
            owner: "www-data"
            group: "www-data"
            mode: "0600"
        - name: 佈署 nginx 設定檔
          template:
            src: "nginx.conf.j2"
            dest: "/etc/nginx/sites-available/{{ project_domain_name }}"
        - name: 啟用 nginx 設定檔
          file:
            src: "/etc/nginx/sites-available/{{ project_domain_name }}"
            dest: "/etc/nginx/sites-enabled/{{ project_domain_name }}"
            state: link
          notify: reload nginx
      tags:
        - deploy_project_only
  handlers:
    - name: restart redis-server
      systemd:
        name: "redis-server.service"
        state: restarted
    - name: reload nginx
      systemd:
        name: "nginx.service"
        state: reloaded
