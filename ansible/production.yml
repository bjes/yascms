---
- hosts: localhost
  connection: local
  roles:
    - pylabs.redis
    - pylabs.uwsgi
    - pylabs.letsencrypt_auth
    - pylabs.percona # for ngram support. MariaDB 目前還不支援
  tasks:
    - block:
        - name: 佈署 production 環境的設定檔
          ansible.builtin.template:
            src: "production.ini.j2"
            dest: "{{ project_base_dir }}/production.ini"
            owner: "www-data"
            group: "www-data"
            mode: "0600"
        - name: import theme tp_yass2020 tasks
          import_tasks: _theme_tp_yass2020_tasks.yml
          tags:
            - install_project_theme_tp_yass2020
        - name: 使用 poetry 安裝專案相依套件
          import_tasks: _poetry_tasks.yml
          tags:
            - install_project_poetry
        - name: import db tasks
          import_tasks: _db_tasks.yml
          tags:
            - install_project_db
        - name: 設定目錄權限
          import_tasks: _permission_tasks.yml
          tags:
            - install_project_permission
        - name: import nginx tasks
          import_tasks: _nginx_tasks.yml
          tags:
            - install_project_nginx_config
        - name: import uwsgi tasks
          import_tasks: _uwsgi_tasks.yml
          tags:
            - install_project_uwsgi_config
      tags:
        - install_project
  handlers:
    - name: restart redis-server
      ansible.builtin.systemd:
        name: "redis-server.service"
        state: restarted
    - name: reload nginx
      ansible.builtin.systemd:
        name: "nginx.service"
        state: reloaded
